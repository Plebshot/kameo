---
title: 演员概述
---

Kameo的核心是其演员。演员是封装状态和行为的对象。它们通过消息传递异步地与系统的其他部分交互，这允许高度的并发和可扩展性。本节提供了Kameo中`Actor`特性的概述，详细说明了其生命周期、消息处理和监督。

### 演员特性概述

`Actor`特性定义了Kameo中一个演员的基本功能和生命周期钩子。实现这个特性允许您创建定制的演员，以满足您应用程序的需求。这里是`Actor`特性的关键组成部分：

- **生命周期钩子**：Kameo提供了几个钩子（`on_start`、`on_stop`、`on_panic`、`on_link_died`），它们在演员生命周期的不同点被调用。这些钩子提供了可以实现自定义行为的干预点，如初始化、清理和错误处理。
- **邮箱**：每个演员都有一个邮箱（`type Mailbox`），可以是有界的或无界的。邮箱是进入消息在被演员处理之前排队的地方。有界邮箱有助于施加背压，防止系统被过多的消息压垮。
- **消息传递**：演员通过发送消息彼此通信。当一个演员被生成时，它返回一个`ActorRef`，这是一个可以用来向其发送消息的演员引用。消息异步发送，并由接收演员顺序处理。
- **监督**：演员可以监督其他演员，允许层次化的错误处理和恢复策略。`on_panic`和`on_link_died`钩子对此至关重要，使演员能够响应其子演员以及自身的失败。

#### **派生演员**

为了简化演员的创建并减少重复的样板代码，Kameo提供了一个`Actor`特性的派生宏。这个宏不仅简化了演员定义过程，还提供了遵循常见实践的合理默认值。

使用派生宏时，您可以使用以下属性自定义演员：

- `#[actor(name = "...")]`：此属性允许您为演员分配一个自定义名称。默认情况下，Kameo使用演员的标识符（ident）作为其名称。指定自定义名称对于日志记录很有用。
- `#[actor(mailbox = ...)]`：通过这个属性，您可以定义演员应该使用的邮箱类型。Kameo支持两种邮箱类型：`bounded`和`unbounded`。
    - **有界邮箱**：对于`bounded`邮箱，您可以使用语法`bounded(<size>)`指定其容量，其中`<size>`表示邮箱可以容纳的最大消息数。如果未指定，默认大小为1000。
    - **无界邮箱**：`unbounded`邮箱没有大小限制，意味着它可以随着接收更多消息无限增长。尽管这确保了由于邮箱容量问题而拒绝的消息永远不会发生，但在高负载下或如果演员无法足够快地处理消息时，可能会导致内存使用增加。

**示例**

```rust
use kameo::Actor;

#[derive(Actor)]
#[actor(name = "MyAmazingActor", mailbox = bounded(64))]
struct MyActor { }
```

### 生命周期管理

- **启动**：`on_start`钩子在演员开始处理消息之前被调用。这是执行任何必要初始化的机会。
- **停止**：演员可以显式停止，或者当所有对它们的`ActorRef`的引用都被丢弃时停止。`on_stop`钩子允许在演员完全停止之前进行清理活动。
- **错误处理**：当演员在处理消息时发生恐慌或遇到错误时，将调用`on_panic`钩子。这个钩子可以决定演员是应该停止还是继续处理消息。
- **链接失败**：当链接的演员死亡时，将调用`on_link_died`钩子，提供了对紧密相关演员的失败做出反应的机会。

### 演员创建和消息传递

创建演员涉及实现`Actor`特性，然后使用`kameo::spawn`生成演员。生成后，返回一个`ActorRef<T>`，用于向演员发送消息。演员使用`Message`特性的`handle`方法处理消息，可选择性地返回回复。

#### 示例用法

```rust
struct MyActor;

impl Actor for MyActor {
    type Mailbox = BoundedMailbox<Self>;

    async fn on_start(&mut self, actor_ref: ActorRef<Self>) -> Result<(), BoxError> {
        println!("Actor started");
        Ok(())
    }

    // 根据需要实现其他生命周期钩子...
}

// 生成演员
let actor_ref = kameo::spawn(MyActor);
```

上面的示例演示了定义一个简单演员并生成它的过程。演员在启动时打印一条消息，展示了使用`on_start`生命周期钩子的用法。

---

#### 总结

演员构成了Kameo的核心，提供了一种将逻辑和状态封装在自包含单元内的结构化方式。这种设计原则促进了系统的可扩展性和弹性，使您能够构建有效管理并发的应用程序，并对失败具有鲁棒性。通过演员，复杂的交互变得可管理，允许系统架构采用模块化方法。